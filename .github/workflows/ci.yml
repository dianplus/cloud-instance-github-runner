name: CI

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]

jobs:
  validate:
    name: Validate Action
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate action.yml
        uses: devops-actions/actionlint@v0.1.3

      - name: Check action.yml syntax
        run: |
          # Basic YAML syntax check
          python3 -c "import yaml; yaml.safe_load(open('action.yml'))"
          echo "✓ action.yml syntax is valid"

      - name: Verify required fields
        run: |
          # Check for required fields in action.yml
          python3 << 'EOF'
          import yaml
          import sys

          with open('action.yml', 'r') as f:
              action = yaml.safe_load(f)

          required_fields = ['name', 'description']
          missing = [field for field in required_fields if field not in action]
          
          if missing:
              print(f"❌ Missing required fields: {', '.join(missing)}")
              sys.exit(1)

          # Check branding section for marketplace
          if 'branding' not in action:
              print("⚠️  Warning: 'branding' section not found. Required for GitHub Marketplace.")
              sys.exit(1)
          else:
              if 'icon' not in action['branding']:
                  print("❌ Missing 'branding.icon'. Required for GitHub Marketplace.")
                  sys.exit(1)
              if 'color' not in action['branding']:
                  print("❌ Missing 'branding.color'. Required for GitHub Marketplace.")
                  sys.exit(1)

          print("✓ Required fields are present")
          print(f"✓ Branding: icon='{action['branding']['icon']}', color='{action['branding']['color']}'")
          EOF

      - name: Check file structure
        run: |
          # Verify essential files exist
          for file in action.yml README.md LICENSE; do
            if [ ! -f "$file" ]; then
              echo "❌ Required file missing: $file"
              exit 1
            fi
          done
          echo "✓ All required files present"
